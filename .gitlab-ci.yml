# ~~ Generated by projen. To modify, edit .projenrc.js and run "npx projen".

default:
  image: jsii/superchain:1-buster-slim
stages:
  - build
  - pre-release
  - release
build:
  stage: build
  rules:
    - when: on_success
  script:
    - yarn install --check-files --frozen-lockfile
    - npx projen
    - git diff --exit-code
    - git config --global user.email gilab-runner@gitlab.com
    - git config --global user.name "Auto-bump"
    - npm version --no-git-tag-version ${CI_COMMIT_TAG#v}
    - npx projen test
    - npx jsii --silence-warnings=reserved-word --no-fix-peer-dependencies
    - npx jsii-docgen
    - npx jsii-pacmak
    - zip -r cdknode.zip dist/js
    - zip -r cdkjava.zip dist/java
    - zip -r cdkpython.zip dist/python
    - zip -r cdkdotnet.zip dist/dotnet
  artifacts:
    paths:
      - cdknode.zip
      - cdkjava.zip
      - cdkpython.zip
      - cdkdotnet.zip
      - dist/
upload_pypi:
  stage: pre-release
  image: python:latest
  rules:
    - if: $CI_COMMIT_TAG =~ /^v\d+(\.\d+){2}$/
      when: on_success
    - when: never
  dependencies:
    - build
  script:
    - pip install twine
    - TWINE_PASSWORD=${CI_JOB_TOKEN} TWINE_USERNAME=gitlab-ci-token python -m twine upload --repository-url ${CI_API_V4_URL}/projects/${CI_PROJECT_ID}/packages/pypi dist/python/*
upload_npm:
  stage: pre-release
  rules:
    - if: $CI_COMMIT_TAG =~ /^v\d+(\.\d+){2}$/
      when: on_success
    - when: never
  dependencies:
    - build
  script:
    - yarn install --check-files --frozen-lockfile
    - export NPM_DIST_TAG="latest"
    - export NPM_REGISTRY="gitlab.aws.dev/api/v4/projects/${CI_PROJECT_ID}/packages/npm/"
    - export NPM_TOKEN="${CI_JOB_TOKEN}"
    - npx -p jsii-release@latest jsii-release-npm
upload_nuget:
  stage: pre-release
  rules:
    - if: $CI_COMMIT_TAG =~ /^v\d+(\.\d+){2}$/
      when: on_success
    - when: never
  dependencies:
    - build
  script:
    - dotnet nuget add source "${CI_API_V4_URL}/projects/${CI_PROJECT_ID}/packages/nuget/index.json" --name gitlab --username gitlab-ci-token --password $CI_JOB_TOKEN --store-password-in-clear-text
    - dotnet nuget push "dist/dotnet/*.nupkg" --source gitlab
upload_artifacts:
  stage: pre-release
  image: curlimages/curl:latest
  rules:
    - if: $CI_COMMIT_TAG =~ /^v\d+(\.\d+){2}$/
      when: on_success
    - when: never
  dependencies:
    - build
  script:
    - 'curl --header "JOB-TOKEN: $CI_JOB_TOKEN" --upload-file cdkpython.zip "${CI_API_V4_URL}/projects/${CI_PROJECT_ID}/packages/generic/cdk-enterprise-utils/${CI_COMMIT_TAG#v}/python.zip"'
    - 'curl --header "JOB-TOKEN: $CI_JOB_TOKEN" --upload-file cdknode.zip "${CI_API_V4_URL}/projects/${CI_PROJECT_ID}/packages/generic/cdk-enterprise-utils/${CI_COMMIT_TAG#v}/node.zip"'
    - 'curl --header "JOB-TOKEN: $CI_JOB_TOKEN" --upload-file cdkjava.zip "${CI_API_V4_URL}/projects/${CI_PROJECT_ID}/packages/generic/cdk-enterprise-utils/${CI_COMMIT_TAG#v}/java.zip"'
    - 'curl --header "JOB-TOKEN: $CI_JOB_TOKEN" --upload-file cdkdotnet.zip "${CI_API_V4_URL}/projects/${CI_PROJECT_ID}/packages/generic/cdk-enterprise-utils/${CI_COMMIT_TAG#v}/dotnet.zip"'
    - 'curl --header "JOB-TOKEN: $CI_JOB_TOKEN" --upload-file API.md "${CI_API_V4_URL}/projects/${CI_PROJECT_ID}/packages/generic/cdk-enterprise-utils/${CI_COMMIT_TAG#v}/API.md"'
    - 'curl --header "JOB-TOKEN: $CI_JOB_TOKEN" --upload-file README.md "${CI_API_V4_URL}/projects/${CI_PROJECT_ID}/packages/generic/cdk-enterprise-utils/${CI_COMMIT_TAG#v}/README.md"'
release:
  stage: release
  image: registry.gitlab.com/gitlab-org/release-cli:latest
  rules:
    - if: $CI_COMMIT_TAG =~ /^v\d+(\.\d+){2}$/
      when: on_success
    - when: never
  dependencies:
    - build
    - upload_artifacts
  script:
    - echo 'running release_job for ${CI_COMMIT_TAG}'
  release:
    name: cdk-enterprise-utils ${CI_COMMIT_TAG}
    description: ./CHANGELOG.md
    tag_name: $CI_COMMIT_TAG
    ref: $CI_COMMIT_TAG
    assets:
      links:
        - name: cdk-enterprise-utils-${CI_COMMIT_TAG}-python
          url: ${CI_API_V4_URL}/projects/${CI_PROJECT_ID}/packages/generic/cdk-enterprise-utils/${CI_COMMIT_TAG#v}/python.zip
          link_type: package
        - name: cdk-enterprise-utils-${CI_COMMIT_TAG}-node
          url: ${CI_API_V4_URL}/projects/${CI_PROJECT_ID}/packages/generic/cdk-enterprise-utils/${CI_COMMIT_TAG#v}/node.zip
          link_type: package
        - name: cdk-enterprise-utils-${CI_COMMIT_TAG}-java
          url: ${CI_API_V4_URL}/projects/${CI_PROJECT_ID}/packages/generic/cdk-enterprise-utils/${CI_COMMIT_TAG#v}/java.zip
          link_type: package
        - name: cdk-enterprise-utils-${CI_COMMIT_TAG}-dotnet
          url: ${CI_API_V4_URL}/projects/${CI_PROJECT_ID}/packages/generic/cdk-enterprise-utils/${CI_COMMIT_TAG#v}/dotnet.zip
          link_type: package
        - name: README
          url: ${CI_API_V4_URL}/projects/${CI_PROJECT_ID}/packages/generic/cdk-enterprise-utils/${CI_COMMIT_TAG#v}/README.md
          link_type: runbook
        - name: API
          url: ${CI_API_V4_URL}/projects/${CI_PROJECT_ID}/packages/generic/cdk-enterprise-utils/${CI_COMMIT_TAG#v}/API.md
          link_type: runbook
